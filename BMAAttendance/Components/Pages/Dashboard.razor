@page "/"
@inject BMAService bmaService
@inject IDialogService dialogService
@using BMAAttendance.Components.Dialogs

<AuthorizeView>
    <Authorized>
        @if (User == null)
        {
            <MudText Typo="Typo.h6">Please contact tech support to repair your user configuration.</MudText>
        }
        else if (User.SchoolID == null)
        {
            <MudText Typo="Typo.h6">Please select the school you are associated with.</MudText>
            <MudSelect @bind-Value="SelectedSchoolID" T="Guid?" Clearable>
                @foreach (BMASchool school in Schools)
                {
                    <MudSelectItem T="Guid?" Value="@school.ID">@school.SchoolName</MudSelectItem>
                }
            </MudSelect>
            <MudButton OnClick="SetSchool" Variant="Variant.Filled" Color="Color.Info" Disabled="SelectedSchoolID == null">Select School</MudButton>
        }
        else
        {
            <MudStack Row>
                <MudButton Variant="Variant.Filled" Color="Color.Info" OnClick="CreateStudent">Create Student</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ViewSchool">View School</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ViewRanks">View Ranks</MudButton>
            </MudStack>
            <MudTable Items="Students" Striped Outlined Context="ctx2">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Rank</MudTh>
                    <MudTh>Email</MudTh>
                    <MudTh># Attend</MudTh>
                    <MudTh># Attends Current Rank</MudTh>
                    <MudTh>View</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">@ctx2.StudentName</MudTd>
                    <MudTd DataLabel="Rank">@Ranks.FirstOrDefault(e => e.ID == ctx2.RankID)?.RankName</MudTd>
                    <MudTd DataLabel="Email">@ctx2.EmailAddress</MudTd>
                    <MudTd DataLabel="Attendance">@ctx2.Attends.Count</MudTd>
                    <MudTd DataLabel="Current Attend">@ctx2.Attends.Count(e => e.AttendDate >= ctx2.DateAwarded)</MudTd>
                    <MudTd>
                        <MudIconButton Color="Color.Info" Icon="@Icons.Material.Filled.ArrowOutward" Href="@($"/student/{ctx2.ID}")" />
                    </MudTd>
                </RowTemplate>
            </MudTable>

        }
    </Authorized>
    <NotAuthorized>
        <MudText Typo="Typo.h6">You must log in to view this content.</MudText>
    </NotAuthorized>
</AuthorizeView>

<MudDialog @bind-Visible="RankDialogView">
    <TitleContent>View Ranks</TitleContent>
    <DialogContent>
        <MudTable Items="Ranks" Striped Bordered RowEditCommit="SaveEdit">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortBy="new Func<BMARank, object>(x=>x.OrderNumber)" InitialDirection="SortDirection.Ascending">#</MudTableSortLabel></MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Major Color</MudTh>
                <MudTh>Second Color</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="#">@context.OrderNumber</MudTd>
                <MudTd DataLabel="Name">@context.RankName</MudTd>
                <MudTd DataLabel="Description">@context.RankDescription</MudTd>
                <MudTd DataLabel="Color 1">
                    <div style="background-color: @context.Color1;">@context.Color1</div>
                </MudTd>
                <MudTd DataLabel="Color 2">
                    <div style="background-color: @context.Color2;">@context.Color2</div>
                </MudTd>
            </RowTemplate>
            <RowEditingTemplate>
                <MudTd DataLabel="#">
                    <MudNumericField @bind-Value="context.OrderNumber" Min="0" HideSpinButtons />
                </MudTd>
                <MudTd DataLabel="Name">
                    <MudTextField @bind-Value="context.RankName" Required />
                </MudTd>
                <MudTd DataLabel="Description">
                    <MudTextField @bind-Value="context.RankDescription" Required />
                </MudTd>
                <MudTd DataLabel="Color 1">
                    <MudColorPicker @bind-Text="context.Color1" Clearable Style="@($"color: {context.Color1}")" />
                </MudTd>
                <MudTd DataLabel="Color 2">
                    <MudColorPicker @bind-Text="context.Color2" Clearable Style="@($"color: {context.Color2}")" />
                </MudTd>
            </RowEditingTemplate>
        </MudTable>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="AddRank" Variant="Variant.Filled" Color="Color.Info">Add Rank</MudButton>
        <MudButton OnClick="CloseRanks" Variant="Variant.Filled">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public BMAUser? User { get; set; }
    private bool Loaded = false;
    private List<BMAStudent> Students { get; set; } = [];
    private List<BMASchool> Schools { get; set; } = [];
    private List<BMARank> Ranks { get; set; } = [];
    protected override void OnInitialized()
    {
        Schools = bmaService.GetSchools();
        Ranks = bmaService.GetRanks();
    }
    protected override void OnParametersSet()
    {
        if (!Loaded && User?.SchoolID != null)
        {
            Loaded = true;
            LoadStudents(User.SchoolID.Value);
        }
    }
    private void LoadStudents(Guid schoolid)
    {
        Students = bmaService.GetStudentsBySchool(schoolid);
        SelectedSchoolID = schoolid;
    }
    private Guid? SelectedSchoolID { get; set; } = null;
    private void SetSchool()
    {
        if (User != null && SelectedSchoolID != null)
        {
            User.SchoolID = SelectedSchoolID;
            bmaService.UpdateUser(User);
            LoadStudents(User.SchoolID.Value);
        }
    }
    private async Task CreateStudent()
    {
        if (SelectedSchoolID == null)
            return;
        var options = new DialogOptions() { CloseOnEscapeKey = true };
        var parameters = new DialogParameters();
        //parameters.Add("Power", Clan.Power);
        var dialog = dialogService.Show<StudentDialog>("Add New Student", parameters, options);
        var result = await dialog.Result;
        if (!result!.Canceled)
        {
            BMAStudent? student = result.Data as BMAStudent;
            if (student != null)
            {
                student.SchoolID = SelectedSchoolID.Value;
                bmaService.CreateStudent(student);
                Students.Add(student);
            }
        }
    }
    private async Task ViewSchool()
    {
        BMASchool? SelectedSchool = Schools.FirstOrDefault(e => e.ID == SelectedSchoolID);
        if (SelectedSchool != null)
        {
            var options = new DialogOptions() { CloseOnEscapeKey = true };
            var parameters = new DialogParameters();
            parameters.Add("School",SelectedSchool);
            parameters.Add("User",User);
            var dialog = dialogService.Show<SchoolDialog>(SelectedSchool?.SchoolName, parameters, options);
            var result = await dialog.Result;
            if (!result!.Canceled)
            {
                BMASchool? school = result.Data as BMASchool;
                if (school != null)
                {
                    bmaService.UpdateSchool(school);
                }
            }
        }
    }
    private async Task AddRank()
    {
        var options = new DialogOptions() { CloseOnEscapeKey = true };
        var parameters = new DialogParameters();
        var dialog = dialogService.Show<RankDialog>("Add New Rank", parameters, options);
        var result = await dialog.Result;
        if (!result!.Canceled)
        {
            BMARank? newrank = result.Data as BMARank;
            if (newrank != null)
            {
                newrank.OrderNumber = Ranks.Select(e => e.OrderNumber).Max() + 1;
                bmaService.CreateRank(newrank);
                Ranks.Add(newrank);
            }
        }
    }
    private bool RankDialogView = false;
    private void ViewRanks()
    {
        RankDialogView = true;
    }
    private void CloseRanks()
    {
        RankDialogView = false;
    }
    private void SaveEdit(object rank)
    {
        BMARank? bMARank = rank as BMARank;
        if (bMARank != null)
            bmaService.UpdateRank(bMARank);
    }
}